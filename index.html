<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>スラスラクイズ（高速・最適化版）</title>
<style>
    body { font-family: 'Helvetica Neue', Arial, sans-serif; padding: 30px; max-width: 600px; margin: auto; background-color: #f4f7f6; }
    h2 { color: #2c3e50; text-align: center; }
    #quizArea { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    #question { font-size: 24px; font-weight: bold; margin-bottom: 15px; min-height: 40px; color: #34495e; }
    #answer { font-size: 20px; padding: 10px; width: calc(100% - 22px); border: 2px solid #ddd; border-radius: 5px; outline: none; }
    #answer:focus { border-color: #3498db; }
    #answer.showing-answer { color: #7f8c8d; cursor: not-allowed; background-color: #fafafa; border-color: #ddd; }
    #score { margin-top: 15px; font-size: 14px; color: #7f8c8d; display: flex; justify-content: space-between; }
    #report { margin-top: 20px; padding: 15px; background: #fff; border-left: 5px solid #3498db; line-height: 1.6; }
    .hidden { display: none; }
</style>
</head>
<body>

<h2>スラスラクイズ</h2>
<div style="text-align: center; margin-bottom: 20px;">
    <input type="file" id="fileInput" accept=".csv,.txt">
</div>

<div id="quizArea" class="hidden">
    <div id="question"></div>
    <input type="text" id="answer" autocomplete="off" placeholder="答えを入力してEnter">
    <div id="score">
        <span>残り: <span id="remainingCount">0</span></span>
        <span>正解: <span id="correctCount">0</span> | 不正解: <span id="mistakeCount">0</span></span>
    </div>
    <div id="report" class="hidden"></div>
</div>

<script>
// --- グローバル変数 ---
let questions = [];
let consecutiveCorrect = 0;       
let totalMistakes = 0;            
let answeredOnceWrong = new Set(); 
let mainQueue = [];       
let currentIndex = null;
let currentIsRevenge = false; // データセットを使わず変数で管理
let isCorrectionMode = false; 
let isFinished = false;

// --- DOM要素のキャッシュ ---
const fileInput = document.getElementById("fileInput");
const quizArea = document.getElementById("quizArea");
const questionEl = document.getElementById("question");
const answerEl = document.getElementById("answer");
const correctCountEl = document.getElementById("correctCount");
const mistakeCountEl = document.getElementById("mistakeCount");
const remainingCountEl = document.getElementById("remainingCount");
const reportEl = document.getElementById("report");

// --- 初期設定：イベントリスナーは1回だけ登録 ---
fileInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (event) => {
        parseFile(event.target.result);
        if(questions.length === 0) return;
        fileInput.classList.add("hidden");
        quizArea.classList.remove("hidden");
        mainQueue = questions.map((_, i) => ({ index: i, isRevenge: false }));
        showNext();
    };
    reader.readAsText(file);
});

// キーイベントを1ヶ所で管理（重複登録を防ぐ）
answerEl.addEventListener("keydown", (e) => {
    if(e.key === "Enter" && !answerEl.disabled && !isFinished) {
        checkAnswer();
    }
});

function parseFile(text){
    // ファイル解析を高速化
    questions = [];
    const lines = text.split(/\r?\n/);
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        if (line === "") continue;
        const parts = line.split(",");
        if (parts.length >= 2) {
            questions.push({ q: parts[0].trim(), a: parts[1].trim() });
        }
    }
}

function updateScore() {
    correctCountEl.textContent = consecutiveCorrect;
    mistakeCountEl.textContent = totalMistakes;
    remainingCountEl.textContent = mainQueue.length;
}

function showNext(){
    if(mainQueue.length === 0){
        finishQuiz();
        return;
    }

    const nextItem = mainQueue.shift();
    currentIndex = nextItem.index;
    currentIsRevenge = nextItem.isRevenge;

    isCorrectionMode = false;
    questionEl.textContent = questions[currentIndex].q;
    answerEl.value = "";
    answerEl.disabled = false;
    answerEl.className = "";
    answerEl.focus();
    updateScore();
}

function checkAnswer(){
    const userAnswer = answerEl.value.trim();
    const correctAnswer = questions[currentIndex].a;

    if(userAnswer === correctAnswer){
        if (isCorrectionMode) {
            // 打ち直し正解 → 再出題を挿入
            injectRevenge(currentIndex);
            showNext();
        } else {
            // 1発正解
            if (currentIsRevenge) {
                totalMistakes = Math.max(0, totalMistakes - 1);
                consecutiveCorrect++;
            } else if (!answeredOnceWrong.has(currentIndex)) {
                consecutiveCorrect++;
            }
            showNext();
        }
    } else {
        processWrong(correctAnswer);
    }
}

function processWrong(correctAnswer) {
    if (!answeredOnceWrong.has(currentIndex)) {
        totalMistakes++;
        answeredOnceWrong.add(currentIndex);
    }
    updateScore();

    isCorrectionMode = true;
    answerEl.value = correctAnswer;
    answerEl.disabled = true; 
    answerEl.classList.add("showing-answer");

    // 視覚的フィードバック時間は文字数ベース（0.8s〜2.5sに制限してテンポアップ）
    const displayTime = Math.min(2.5, Math.max(0.8, correctAnswer.length * 0.15));

    setTimeout(() => {
        answerEl.disabled = false;
        answerEl.value = "";
        answerEl.classList.remove("showing-answer");
        answerEl.focus();
    }, displayTime * 1000);
}

function injectRevenge(idx) {
    const len = mainQueue.length;
    if (len === 0) {
        mainQueue.push({ index: idx, isRevenge: true });
        return;
    }
    
    // 2〜6問後のランダム位置
    const offset = Math.floor(Math.random() * 5) + 2; 
    let targetPos = Math.min(offset - 1, len);

    // 連続防止（残弾がある場合のみ）
    if (targetPos === 0 && len > 0) targetPos = 1;

    mainQueue.splice(targetPos, 0, { index: idx, isRevenge: true });
}

function finishQuiz(){
    isFinished = true;
    questionEl.textContent = "学習完了！";
    answerEl.classList.add("hidden");
    updateScore();
    
    const wrongList = [...answeredOnceWrong].map(i => questions[i].q).join(", ");
    reportEl.innerHTML = `
        <strong>最終レポート</strong><br>
        一発正解数: ${consecutiveCorrect}<br>
        未習得数: ${totalMistakes}<br>
        <small style="color:#7f8c8d;">一度でも間違えた問題: ${wrongList || 'なし'}</small>
    `;
    reportEl.classList.remove("hidden");
}
</script>

</body>
</html>
